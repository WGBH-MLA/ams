#!/usr/bin/env ruby
require File.expand_path('../config/environment', __FILE__) unless defined?(Rails) && Rails.env
require 'hyrax/benchmark'

trials = ENV.fetch('TRIALS', 10).to_i
timestamp = Time.now.strftime('%Y%m%d-%H%M%S')
output_file = ENV.fetch('OUTPUT_FILE', "./benchmarks/#{timestamp}.#{trials}_generic_works.csv")

# Create a place for the output file if needed.
FileUtils.mkdir_p File.dirname output_file


depositor = User.create! email: "benchmark#{rand.to_s.sub('.', '')}@example.com", password: "password"

b = Hyrax::Benchmark.new(output_file: output_file)
b.procedure do
  generic_work = GenericWork.new title: ["some title"]
  ability = Ability.new depositor
  env = Hyrax::Actors::Environment.new(generic_work, ability, {})
  actor = Hyrax::CurationConcern.actor
  raise "Failed to save record:\n#{generic_work.errors.messages.join("\n")}" unless actor.create(env)
end

b.measure(:repository_size) { ActiveFedora::Base.count }
b.measure(:solr_size) do
  ActiveFedora.solr.conn.get(:select)['response']['numFound']
end

b.run trials: trials
